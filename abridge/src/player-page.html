<!DOCTYPE html>
<html>

<head>
    <title> [% format!("{:?}", self.0.seat) %] </title>
    <link rel="stylesheet" href="[% self.0.game.root as URL %]style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<script src='https://meet.jit.si/external_api.js'></script>
<script type="text/javascript">
    var api;
    document.addEventListener("DOMContentLoaded", () => {
        const options = {
            roomName: 'ABridgeGame',
            width: "100%",
            height: 218,
            parentNode: document.querySelector('#meet'),
            userInfo: {
                displayName: '[% format!("{:?}", self.0.seat) %]'
            },
            configOverwrite: {
                prejoinPageEnabled: false,
                toolbarButtons: ['microphone', 'camera', 'hangup'],
            },
            interfaceConfigOverwrite: {
                DISABLE_DOMINANT_SPEAKER_INDICATOR: true,
                DISABLE_JOIN_LEAVE_NOTIFICATIONS: true,
                INITIAL_TOOLBAR_TIMEOUT: 500,
                SHOW_CHROME_EXTENSION_BANNER: false,
                MOBILE_APP_PROMO: false,
                TOOLBAR_TIMEOUT: 250,
                VIDEO_LAYOUT_FIT: 'nocrop',
                VERTICAL_FILMSTRIP: false
            },
            resolution: 240,
            constraints: {
                video: {
                    height: {
                        ideal: 240,
                        max: 720,
                        min: 240,
                    },
                },
            },
            lang: 'en'
        };
        api = new JitsiMeetExternalAPI('8x8.vc', options);
        api.executeCommand('setTileView', true);
    });

    var ws_protocol = 'ws://';
    if (location.protocol == 'https:') {
        ws_protocol = 'wss://';
    }
    const ws = new WebSocket(ws_protocol + location.host + location.pathname + '/ws');
    console.log('did websocket');

    ws.onopen = function () {
        console.log('connected');
    };
    ws.onmessage = function (event) {
        console.log('got html data');
        document.getElementById('main').innerHTML = event.data;
    };
    ws.onclose = function () {
        console.log('disconnected');
        location.reload();
    };
    function send_message(action) {
        ws.send(action);
    }
    var timer;
    function sendname() {
        window.clearTimeout(timer);
        timer = window.setTimeout(function () {
            let name = document.getElementById('myname').innerText;
            document.cookie = "name=" + name;
            api.executeCommand('displayName', name);
            ws.send(JSON.stringify({ "Name": name }));
        }, 3000);
    }
</script>

<body>
    <details id="meet" open><summary>Video chat</summary></details>
    <button class="robots" onclick="window.open(window.location + '/robot','newwindow', 'width=300,height=250')">Robots</button>
    <button class="redeal" [% Action::Redeal %]>Redeal</button>
    <main id="main">[% self.0 %]</main>
</body>

</html>